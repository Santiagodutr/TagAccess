{% extends "layout.html" %}
{% block title %}Dashboard · TagPass{% endblock %}

{% block content %}
<section class="dashboard">
  <header class="dashboard__header">
    <h1>Panel de Control</h1>
    <p>Monitorea los eventos de acceso RFID del sistema.</p>
  </header>

  {% if logs_error %}
  <div class="banner banner--error">
    Advertencia: Error al cargar registros: {{ logs_error }}
  </div>
  {% endif %}

  <!-- ESTADÍSTICAS -->
  <section class="stat-cards">
    <article class="stat-card">
      <h2 class="stat-card__title">Total de Eventos</h2>
      <p class="stat-card__value">{{ logs|length }}</p>
    </article>
    <article class="stat-card">
      <h2 class="stat-card__title">Acceso Autorizado</h2>
      <p class="stat-card__value" style="color: #48bb78;">
        {{ logs|selectattr("_is_authorized", "equalto", true)|list|length }}
      </p>
    </article>
    <article class="stat-card">
      <h2 class="stat-card__title">Acceso Denegado</h2>
      <p class="stat-card__value" style="color: #f56565;">
        {{ logs|selectattr("_is_authorized", "equalto", false)|list|length }}
      </p>
    </article>
  </section>



  <!-- FILTROS SIMPLIFICADOS -->
  <section class="dashboard__filters">
    <h2>Filtrar Accesos</h2>
    <form class="filters" method="get" id="filters-form">
      <div class="filters__row">
        <div class="filters__field">
          <label for="search-type">Tipo de Búsqueda</label>
          <select id="search-type" name="search_type" onchange="updateSearchInput()">
            <option value="all" {% if filters.search_type == 'all' or not filters.search_type %}selected{% endif %}>Todos</option>
            <option value="name" {% if filters.search_type == 'name' %}selected{% endif %}>Por Nombre (Tarjeta)</option>
            <option value="code" {% if filters.search_type == 'code' %}selected{% endif %}>Por Código (Tarjeta)</option>
            <option value="uid" {% if filters.search_type == 'uid' %}selected{% endif %}>Por UID (Tarjeta)</option>
            <option value="user" {% if filters.search_type == 'user' %}selected{% endif %}>Por Usuario Asignado</option>
          </select>
        </div>

        <div class="filters__field">
          <label for="student">Buscar</label>
          <!-- Input de texto para búsqueda por nombre, código, UID -->
          <input 
            id="student" 
            name="student" 
            type="text"
            placeholder="Escribe para buscar..."
            value="{{ filters.student }}"
            list="search-options"
            autocomplete="off"
            style="display: {% if filters.search_type == 'user' %}none{% else %}block{% endif %};"
          >
          <datalist id="search-options">
            <!-- Se llena dinámicamente con JavaScript -->
          </datalist>
          
          <!-- Select para búsqueda por usuario -->
          <select 
            id="student-select" 
            name="student" 
            style="display: {% if filters.search_type == 'user' %}block{% else %}none{% endif %};"
            onchange="document.getElementById('filters-form').submit();"
          >
            <option value="">— Seleccionar Usuario —</option>
            {% for user in filter_options.users %}
            <option value="{{ user.id }}" {% if user.id == filters.student %}selected{% endif %}>{{ user.name }} ({{ user.email }})</option>
            {% endfor %}
          </select>
        </div>

        <div class="filters__field">
          <label for="building">Edificio</label>
          <select id="building" name="building" onchange="updateRoomsByBuilding()">
            <option value="">Todos</option>
            {% for building in filter_options.buildings %}
            <option value="{{ building }}" {% if building == filters.building %}selected{% endif %}>{{ building }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="filters__field">
          <label for="room">Salón</label>
          <select id="room" name="room">
            <option value="">Todos</option>
            {% if filters.building and filters.building in filter_options.rooms_by_building %}
              {% for room in filter_options.rooms_by_building[filters.building] %}
              <option value="{{ room.name }}" {% if room.name == filters.room %}selected{% endif %}>{{ room.name }}</option>
              {% endfor %}
            {% else %}
              {% for room in filter_options.get('rooms', []) %}
              <option value="{{ room }}" {% if room == filters.room %}selected{% endif %}>{{ room }}</option>
              {% endfor %}
            {% endif %}
          </select>
        </div>

        <div class="filters__field">
          <label for="start_date">Desde (Fecha y Hora)</label>
          <input id="start_date" name="start_date" type="datetime-local" value="{{ filters.start_date }}">
        </div>

        <div class="filters__field">
          <label for="end_date">Hasta (Fecha y Hora)</label>
          <input id="end_date" name="end_date" type="datetime-local" value="{{ filters.end_date }}">
        </div>
      </div>

      <div class="filters__actions">
        <button class="btn btn--primary" type="submit">Aplicar Filtros</button>
        <a class="btn btn--secondary" href="{{ url_for('dashboard') }}">Limpiar</a>
      </div>
    </form>
  </section>

  <!-- TABLA DE ACCESOS -->
  <section class="dashboard__table">
    <h2>Últimos Accesos</h2>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Estudiante</th>
            <th>Salón</th>
            <th>Estado</th>
            <th>Hora</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% if logs %}
            {% for log in logs %}
            <tr>
              <td data-title="Estudiante">
                <strong>{{ log._student_label or "Desconocido" }}</strong>
                <br>
                <small style="color: #718096;">{{ log._student_code or log.card_uid or "N/D" }}</small>
              </td>
              <td data-title="Salón">
                {{ log._room_label or "—" }} {% if log._building_label %}<br><small>{{ log._building_label }}</small>{% endif %}
              </td>
              <td data-title="Estado">
                {% if log._is_authorized %}
                  <span class="badge badge--success">Autorizado</span>
                {% else %}
                  <span class="badge badge--danger">Denegado</span>
                {% endif %}
              </td>
              <td data-title="Hora">
                <small>{{ log._timestamp[:16]|replace('T', ' ') if log._timestamp else "N/D" }}</small>
              </td>
              <td data-title="Acciones">
                <div class="action-menu">
                  <button class="action-menu__toggle" onclick="toggleMenu(event, 'menu-{{ loop.index }}')">⋮</button>
                  <div id="menu-{{ loop.index }}" class="action-menu__dropdown" style="display: none;">
                    <button type="button" class="action-menu__item" onclick="openBlockMenuModal('{{ log.card_uid }}', '{{ log._student_label }}', '{{ log._room_label }}')">
                      Bloquear Tarjeta
                    </button>
                  </div>
                </div>
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td class="table__empty" colspan="5">No hay registros con los filtros seleccionados.</td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </section>
</section>

<!-- MODAL DE BLOQUEO -->
<div id="block-modal" class="modal">
  <div class="modal__content">
    <div class="modal__header">
      <h3>Bloquear Acceso a Tarjeta</h3>
      <button class="modal__close" onclick="closeBlockModal()">&times;</button>
    </div>
    <form method="post" action="{{ url_for('block_access') }}" class="form" id="block-form">
      <div class="form__group">
        <label class="form__label" for="block-student">Estudiante</label>
        <input class="form__input" id="block-student" name="student_name" type="text" readonly>
      </div>

      <div class="form__group">
        <label class="form__label" for="block-card-uid">UID Tarjeta</label>
        <input class="form__input" id="block-card-uid" name="card_uid" type="text" readonly>
      </div>
      
      <div class="form__group">
        <label class="form__label" for="block-room">Salón</label>
        <select class="form__input" name="room_id" id="block-room" required>
          <option value="">— Seleccionar Salón —</option>
          {% for building_name, rooms in filter_options.rooms_by_building.items() %}
            <optgroup label="{{ building_name }}">
              {% for room in rooms %}
              <option value="{{ room.id }}">{{ room.name }}</option>
              {% endfor %}
            </optgroup>
          {% endfor %}
        </select>
      </div>

      <div class="form__group">
        <label class="form__label" for="block-reason">Motivo del Bloqueo</label>
        <textarea class="form__input" id="block-reason" name="reason" placeholder="Describe el motivo..." style="min-height: 100px; resize: vertical;"></textarea>
      </div>

      <div class="modal__footer">
        <button class="btn btn--secondary" type="button" onclick="closeBlockModal()">Cancelar</button>
        <button class="btn btn--danger" type="submit">Bloquear Tarjeta</button>
      </div>
    </form>
  </div>
</div>

<script>
  // Almacenar datos de búsqueda desde Jinja2
  const searchData = {
    names: [
      {% for name in filter_options.students_by_name %}
      "{{ name }}",
      {% endfor %}
    ],
    codes: [
      {% for code in filter_options.students_by_code %}
      "{{ code }}",
      {% endfor %}
    ],
    uids: [
      {% for uid in filter_options.students_by_uid %}
      "{{ uid }}",
      {% endfor %}
    ],
    users: [
      {% for user in filter_options.users %}
      { id: "{{ user.id }}", name: "{{ user.name }}", email: "{{ user.email }}" },
      {% endfor %}
    ],
  };

  // Almacenar datos de salones por edificio desde Jinja2
  const roomsByBuilding = {
    {% for building_name, rooms in filter_options.rooms_by_building.items() %}
    "{{ building_name }}": [
      {% for room in rooms %}
      { id: "{{ room.id }}", name: "{{ room.name }}" },
      {% endfor %}
    ],
    {% endfor %}
  };

  function updateSearchInput() {
    const searchType = document.getElementById('search-type').value;
    const studentInput = document.getElementById('student');
    const studentSelect = document.getElementById('student-select');
    const datalist = document.getElementById('search-options');

    // Mostrar/ocultar input y select según el tipo de búsqueda
    if (searchType === 'user') {
      // Mostrar select para usuarios, ocultar input
      studentInput.style.display = 'none';
      studentSelect.style.display = 'block';
      // Limpiar input de texto para evitar conflictos
      studentInput.value = '';
    } else {
      // Mostrar input, ocultar select
      studentInput.style.display = 'block';
      studentSelect.style.display = 'none';
      // Limpiar select para evitar conflictos
      studentSelect.value = '';
      
      // Limpiar datalist
      datalist.innerHTML = '';

      // Obtener opciones según el tipo de búsqueda
      let options = [];
      switch (searchType) {
        case 'name':
          options = searchData.names;
          break;
        case 'code':
          options = searchData.codes;
          break;
        case 'uid':
          options = searchData.uids;
          break;
        case 'all':
        default:
          // Mostrar todo
          options = [
            ...searchData.names,
            ...searchData.codes,
            ...searchData.uids,
          ];
          break;
      }

      // Agregar opciones al datalist
      options.forEach(option => {
        const optElement = document.createElement('option');
        optElement.value = option;
        datalist.appendChild(optElement);
      });
    }
    
    document.getElementById('search-type').dataset.lastType = searchType;
  }

  function updateRoomsByBuilding() {
    const buildingSelect = document.getElementById('building');
    const roomSelect = document.getElementById('room');
    const selectedBuilding = buildingSelect.value;

    // Limpiar opciones excepto la primera (Todos)
    while (roomSelect.options.length > 1) {
      roomSelect.remove(1);
    }

    // Si se selecciona un edificio específico, mostrar sus salones
    if (selectedBuilding && roomsByBuilding[selectedBuilding]) {
      const rooms = roomsByBuilding[selectedBuilding];
      rooms.forEach(room => {
        const option = document.createElement('option');
        option.value = room.name;
        option.text = room.name;
        roomSelect.appendChild(option);
      });
    }
  }

  function toggleMenu(event, menuId) {
    event.stopPropagation();
    const menu = document.getElementById(menuId);
    
    // Cerrar otros menús
    document.querySelectorAll('.action-menu__dropdown').forEach(m => {
      if (m.id !== menuId) {
        m.style.display = 'none';
      }
    });
    
    // Toggle menú actual
    menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
  }

  function openBlockMenuModal(cardUid, studentLabel, roomLabel) {
    document.getElementById('block-student').value = studentLabel;
    document.getElementById('block-card-uid').value = cardUid;
    document.getElementById('block-room').value = roomLabel || '';
    document.getElementById('block-reason').value = '';
    
    // Cerrar menú
    document.querySelectorAll('.action-menu__dropdown').forEach(m => {
      m.style.display = 'none';
    });
    
    document.getElementById('block-modal').classList.add('active');
  }

  function closeBlockModal() {
    document.getElementById('block-modal').classList.remove('active');
    document.getElementById('block-form').reset();
  }

  // Cerrar menús al hacer click afuera
  document.addEventListener('click', function(event) {
    if (!event.target.closest('.action-menu')) {
      document.querySelectorAll('.action-menu__dropdown').forEach(m => {
        m.style.display = 'none';
      });
    }
  });

  // Cerrar modal con Escape
  document.addEventListener('keydown', event => {
    if (event.key === 'Escape') {
      closeBlockModal();
    }
  });

  // Inicializar filtros al cargar la página
  document.addEventListener('DOMContentLoaded', () => {
    // Actualizar autocompletado según el tipo seleccionado
    updateSearchInput();
    
    // Si hay un edificio seleccionado, actualizar salones
    const building = document.getElementById('building').value;
    if (building) {
      updateRoomsByBuilding();
    }
  });
</script>
{% endblock %}
